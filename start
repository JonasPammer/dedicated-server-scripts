#!/bin/bash

# important: set pipefail bash option, see https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/
set -eo pipefail

# import global utils
source utils.sh

# initialize global utils
log_do_init
mkdir -p "${TEMP_DIR}"
#mktemp -d "${TEMP_DIR}"
trap end_sigint SIGINT

log_info "= Make sure programs I always need are installed"
log_info "== (Unattended) Refresh APT-Sources"
apt_get_without_interaction "update" | log_debug_output

log_info "== (Unattended) Installing Tools available in the default Debian-Buster repository..."
sftw=""
#######################################
### SOFTWARE USED BY THIS SCRIPT
sftw="${sftw} sudo" # Provide limited super user privileges to specific users
sftw="${sftw} net-tools" # This package includes the important tools for controlling the network subsystem of the Linux kernel. This includes arp, ifconfig, netstat, rarp, nameif and route.
# sftw="${sftw} apt-transport-https" # No longer needed - https support has been moved into the apt package in 1.5. See https://packages.debian.org/en/buster/apt-transport-https
sftw="${sftw} software-properties-common" # useful scripts for adding and removing PPAs.
sftw="${sftw} gdebi-core" # like apt, but for local packages - Used to easily install a package INCLUDING all of its dependencies (Uses dpkg as backend).
sftw="${sftw} wget" # retrieves files from the web.
sftw="${sftw} curl" # command line tool for transferring data with URL syntax.
sftw="${sftw} nano" # small, friendly text editor inspired by Pico.
sftw="${sftw} dialog" # Displays user-friendly dialog boxes from shell scripts.
sftw="${sftw} zip unzip" # (De-)Archiver for .zip files. https://stackoverflow.com/questions/10540935/what-is-the-difference-between-tar-and-zip
sftw="${sftw} pwgen" # generates random, meaningless but pronounceable passwords.
sftw="${sftw} lolcat" # colorful 'cat'.

#######################################
### SOFTWARE NOT USED BY THIS SCRIPT
sftw="${sftw} man-db" # provides the man command, the primary way of examining the on-line help files (manual pages).
sftw="${sftw} bash-completion" # extends bash's standard completion behavior to achieve complex command lines with just a few keystrokes.
sftw="${sftw} lsof" # lists information about any files that are open, by processes currently running on the system.
sftw="${sftw} telnet" #
sftw="${sftw} screen" # terminal multiplexer with VT100/ANSI terminal emulation.
sftw="${sftw} locate" # 'updatedb' generates an index of files and directories. 'locate' can be used to quickly query this index.
sftw="${sftw} htop" # alternative to top - an interactive system-monitor, process-viewer and process-manager
sftw="${sftw} git" # fast, scalable, distributed revision control system
sftw="${sftw} clamav" # anti-virus utility for Unix - command-line interface
sftw="${sftw} clamav-daemon" # anti-virus utility for Unix - scanner daemon
sftw="${sftw} ranger" # Console File Manager with VI Key Bindings
sftw="${sftw} exa" # Modern replacement for ls - It knows about symlinks, extended attributes, and Git.
sftw="${sftw} tree" # displays an indented directory tree, in color.
sftw="${sftw} ffmpeg " # Tools for transcoding, streaming and playing of multimedia files.
sftw="${sftw} dos2unix " # Converts text file line endings between CRLF and LF.
sftw="${sftw} neofetch screenfetch" # Shows Linux System Information with Distribution Logo.
sftw="${sftw} speedtest-cli" # Command line interface for testing internet bandwidth using speedtest.net.

#######################################
### OTHER
sftw="${sftw} cmatrix" # simulates the display from "The Matrix".

apt_get_without_interaction "install" "${sftw}" | log_debug_output

# Explained in https://askubuntu.com/a/610079
log_info "== Creating bash-alias'es to be applied for new users..."
cat << EOF > /etc/profile.d/.bash_aliases
# Generated by ${SCRIPT_NAME} on $(date)
alias l='ls -CF'
alias la='ls -A'
alias ll='ls -alF'
alias ls='ls --color=auto'

alias ipe='curl ipinfo.io/ip'
EOF

log_info "== Making sure Java 8 is installed..."
if hash java 2>/dev/null; then
  log_info "=== All fine! Java is installed."
else
  ## Installation as described in https://installvirtual.com/install-java-8-on-debian-10-buster/
  log_error "=== Start Install OpenJDK8"

  log_info "==== Adding repository..."
  wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo apt-key add -
  add-apt-repository --yes https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/ | log_debug_output

  log_info "==== Updating sources..."
  apt_get_without_interaction "update" | log_debug_output

  log_info "==== Installing..."
  apt_get_without_interaction "install" "adoptopenjdk-8-hotspot" | log_debug_output
fi

log_info "java -version: $(java -version)"

log_info "= Start mainmenu-loop"
while :
do
  log_info "= Start mainmenu"
  . mainmenu.sh
done



end_gracefully