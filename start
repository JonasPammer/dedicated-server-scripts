#!/bin/bash

# important: set pipefail bash option, see https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/
set -eo pipefail

# import global utils
source utils.sh

# initialize global utils
log_do_init
mkdir -p "${TEMP_DIR}"
#mktemp -d "${TEMP_DIR}"
trap end_sigint SIGINT

log_info "= Make sure programs I always need are installed"
log_info "== (Unattended) Refresh APT-Sources"
apt_get_without_interaction "update" | log_debug_output

log_info "== (Unattended) Installing Tools from the default Debian-Buster repository..."
apt_get_without_interaction "install" "sudo \
    man \
    dos2unix \
    git \
    locate \
    screen \
    nano \
    zip unzip \
    wget \
    software-properties-common \
    apt-transport-https \
    neofetch screenfetch \
    htop \
    dialog \
    ffmpeg \
    ranger exa tree \
    pwgen \
    lolcat" | log_debug_output

log_info "== (Unattended) Installing 'gimmick' Tools from the default Debian-Buster repository..."
apt_get_without_interaction "install" "cmatrix speedtest-cli" | log_debug_output

# Explained in https://askubuntu.com/a/610079
log_info "== Creating bash-alias'es to be applied for new users..."
cat << EOF > /etc/profile.d/.bash_aliases
# Generated by ${SCRIPT_NAME} on $(date)
alias l='ls -CF'
alias la='ls -A'
alias ll='ls -alF'
alias ls='ls --color=auto'

alias ipe='curl ipinfo.io/ip'
EOF


log_info "== Making sure Java 8 is installed..."
if hash java 2>/dev/null; then
  log_info "=== All fine! Java is installed."
else
  ## Installation as described in https://installvirtual.com/install-java-8-on-debian-10-buster/
  log_error "=== Installing OpenJDK8..."

  log_info "==== Adding repository..."
  wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo apt-key add -
  add-apt-repository --yes https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/ | log_debug_output

  log_info "==== Updating sources..."
  apt_get_without_interaction "update" | log_debug_output

  log_info "==== Installing..."
  apt_get_without_interaction "install" "adoptopenjdk-8-hotspot" | log_debug_output
fi

log_info "java -version: $(java -version)"

log_info "= Start mainmenu-loop"
while :
do
  log_info "= Start mainmenu"
  . mainmenu.sh
done




#
end_gracefully